//
//  ResultInteractor.swift
//  ifood-mobile-test
//
//  Created by Marcio Garcia on 01/12/18.
//  Copyright (c) 2018 oxltech.com. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

protocol ResultBusinessLogic {
    func analyzeSentiment()
}

protocol ResultDataStore {
    var tweetText: String { get set }
}

class ResultInteractor: ResultBusinessLogic, ResultDataStore {
  
    var presenter: ResultPresentationLogic?
    var worker: ResultWorker?
    var tweetText: String = ""
    
    init(configuration: Configuration) {
        
        let restService = AlamofireWrapper(environment: configuration.environment,
                                           baseUrl: configuration.value(for: .baseUrl),
                                           apiKey: configuration.value(for: .apiKey),
                                           appVersion: configuration.value(for: .appVersion))
        
        let networkService = NetworkService(restService: restService)
        
        worker = ResultWorker(dataService: networkService)
    }
    
    // MARK: Do something

    func analyzeSentiment() {
        
        worker?.requestSentimentAnalysis(text: tweetText, completion: { [weak self] (analyzedSentiment, error) in
            
            if let _error = error, let message = _error.userInfo["message"] as? String {
                let response = Result.Error.Response(code: _error.code, message: message)
                self?.presenter?.presentError(response: response)
            }
            else {
                guard let sentiment = analyzedSentiment else {
                    let response = Result.Error.Response(code: 999, message: "Cannot evaluate the tweet's mood")
                    self?.presenter?.presentError(response: response)
                    return
                }
                let response = Result.AnalyzeSentiment.Response(analyzedSentiment: sentiment)
                self?.presenter?.presentSentiment(response: response)
            }
        })
    }
}
